# JSON WEB TOKEN (JWT)

- https://jwt.io/
- https://github.com/ticarpi/jwt_tool

**Example :**  
`eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6Imd1ZXN0IiwiZXhwIjoxNjY1MDc2ODM2fQ.C8Z3gJ7wPgVLvEUonaieJWBJBYt5xOph2CpIhlxqdUw`

They are divided in 3 pars separated by a dot, they are basically ***base64 urlsafe encoded*** (not base64 encoded)
- ***Header :*** eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9
- ***Payload :*** eyJ1c2VybmFtZSI6Imd1ZXN0IiwiZXhwIjoxNjY1MDc2ODM2fQ
- ***Signature :*** C8Z3gJ7wPgVLvEUonaieJWBJBYt5xOph2CpIhlxqdUw

### Header

```
{
  "typ": "JWT",
  "alg": "HS256"
}
```

### Payload 

```json
{
  "username": "guest",
  "iat": 1719140868, // issued at 
  "nbf": 1719140868, // not before (only valid after the timestamp)
  "jti": "1d8da5e8-b594-41fb-998c-95dfd06813e0", // JWT ID
  "exp": 1719141048, // expires (not valid after the timestamp)
  "fresh" : True,    // new JWT obtained by giving username/password
  "type" : "access"  // type of the JWT ("access',"refresh",...)
}
```
**Note :** The payload is base64 URL-safe encoded which means that 
- `+` are replaced by `-`
- `/` are replaced by `_`
- There is no `=` at the end
### Signature

Signature is computed with the server secret key and algorithm.  


| HMAC                   | RSA                  | ECDSA                  |
| ---------------------- | -------------------- | ---------------------- |
| Symetric               | Asymetric            | Asymetric              |
| Faster                 | Slower               | Slower                 |
| Deal with symetric key | x                    | x                      |
| HS256 (HMAC + SHA256)  | RS256 (RSA + SHA256) | ES256 (ECDSA + SHA256) |
| HS384 (HMAC + SHA384)  | RS384 (RSA + SHA384) | ES384 (ECDSA + SHA384) |
| HS512 (HMAC + SHA512)  | RS512 (RSA + SHA512) | ES512 (ECDSA + SHA512) |

***Note :*** As the signature is **Base64 URL-Safe encoded**, the last 2 or 4 bits may be dropped when verifying or decoding the JWT
***WARNING :*** Do not compare undecoded JWT as strings because the last bits of the signature can be modified without affecting the JWT

## Transmission

JWTs can be transmitted in cookies, in HTTP common header or dedicated headers

They are often used in HTTP headers like this:  
`Authorization: Bearer eyJ0eXAiOiJKV1QiLCJh...`


## Signing 

Signature can be generated with symmetric (e.g. HS256) or asymmetric (e.g. RS256) encryption

- `HS256` stands for `HMAC + SHA256` (Symmetric)
- `RS256` stands for `RSA + SHA256` (Asymmetric)

# Generate asymetric keys

```bash
openssl genpkey -algorithm RSA -out private_key.pem -pkeyopt rsa_keygen_bits:2048
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

# None, none, NONE, nOnE algorithm  
Modify the header section of the token so that the alg header would contain the value none.    
Remove the signature part but leave the dot, the dot is important  
Patch a while ago but can work on old configurations  

***Example :***  
`eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJ1c2VybmFtZSI6ImFkbWluIn0=.`

- ***header :*** `{"typ":"JWT","alg":"none"}`
- ***payload :*** `{" username":"admin"}`

NOTE : IT IS POSSIBLE TO USE ANY CASE VARIATION

#### Weak secret key

Symmetric encryption
***Example with a 4 digit key***

```bash
hashcat jwt.txt -m 16500 -a 3 -w 2 ?d?d?d?d
```

#### No signature verification

Rare but, it happens sometimes


# Algorithm confusion

https://portswigger.net/web-security/jwt/algorithm-confusion

- Algorithm confusion vulnerability appears when the server does not handle correctly the signing algorithm
- It requires the server to use an asymmetric signature by default and the server should give its public key

The `alg` header can then be set to `HS256` to symmetrically sign the JWT with the public key.

**Note :** the format for storing the public key should be exactly the same as the server stores it

Public keys are generally stored in standard endpoints such as : 
- `/jwks.json`
- `/.well-known/jwks.json`

1. [Obtain the server's public key](https://portswigger.net/web-security/jwt/algorithm-confusion#step-1-obtain-the-server-s-public-key)
2. [Convert the public key to a suitable format](https://portswigger.net/web-security/jwt/algorithm-confusion#step-2-convert-the-public-key-to-a-suitable-format)
	1. X.509
	2. JWK
		For the purpose of this example, let's assume that we need the key in X.509 PEM format. You can convert a JWK to a PEM using the [JWT Editor](https://portswigger.net/bappstore/26aaa5ded2f74beea19e2ed8345a93dd) extension in Burp as follows:
		
		1. With the extension loaded, in Burp's main tab bar, go to the **JWT Editor Keys** tab.
		2. Click **New RSA** Key. In the dialog, paste the JWK that you obtained earlier.
			1. Be careful to copy and paste only the key and not the surrounding
		3. Select the **PEM** radio button and copy the resulting PEM key.
			1. Dont forget to copy the last line feed
		4. Go to the **Decoder** tab and Base64-encode the PEM.
		5. Go back to the **JWT Editor Keys** tab and click **New Symmetric Key**.
		6. In the dialog, click **Generate** to generate a new key in JWK format.
		7. Replace the generated value for the `k` parameter with a Base64-encoded PEM key that you just copied.
		8. Save the key.
1. [Create a malicious JWT](https://portswigger.net/web-security/jwt/algorithm-confusion#step-3-modify-your-jwt) with a modified payload and the `alg` header set to `HS256`.
2. [Sign the token with HS256](https://portswigger.net/web-security/jwt/algorithm-confusion#step-4-sign-the-jwt-using-the-public-key), using the public key as the secret.
	1. Send the request to the repeater
	1. Use the JSON Web Token sub-tab to edit and sign the token

# JWT Header injection

Only the `alg` header parameter is mandatory. In practice, however, JWT headers (also known as JOSE headers) often contain several other parameters. The following ones are of particular interest to attackers.

- `jwk` (JSON Web Key) - Provides an embedded JSON object representing the key.
- `jku` (JSON Web Key Set URL) - Provides a URL from which servers can fetch a set of keys containing the correct key.
- `kid` (Key ID) - Provides an ID that servers can use to identify the correct key in cases where there are multiple keys to choose from. Depending on the format of the key, this may have a matching `kid` parameter.

## Self signed JWT via jwk parameter (asymetric)
A JWK (JSON Web Key) is a standardized format for representing keys as a JSON object.

Sometimes, the server does not correctly handle the jdk parameter allowing to user to send his own custom public to verify the JWT signature.

**Example :**
```bash
"jwk": { 
	"kty": "RSA", 
	"e": "AQAB", 
	"kid": "ed2Nf8sb-sD6ng0-scs5390g-fFD8sfxG", 
	"n": "yy1wpYmffgXBxhAUJzHHocCuJolwDqql75ZWuCQ_cb33K2vh9m" 
}
```

**In BurpSuite**
1. With the extension loaded, in Burp's main tab bar, go to the **JWT Editor Keys** tab.
2. [Generate a new RSA key.](https://portswigger.net/burp/documentation/desktop/testing-workflow/session-management/jwts#adding-a-jwt-signing-key)
3. Send a request containing a JWT to Burp Repeater.
4. In the message editor, switch to the extension-generated **JSON Web Token** tab and [modify](https://portswigger.net/burp/documentation/desktop/testing-workflow/session-management/jwts#editing-jwts) the token's payload however you like.
5. Click **Attack**, then select **Embedded JWK**. When prompted, select your newly generated RSA key.
6. Send the request to test how the server responds.


## Self signed JWT via jku parameter

Instead of embedding public keys directly using the `jwk` header parameter, some servers let you use the `jku` (JWK Set URL) header parameter to reference a JWK Set containing the key. When verifying the signature, the server fetches the relevant key from this URL.

**Endpoint example :**
```json
{ "keys": 
	[ 
		{ 
			"kty": "RSA", 
			"e": "AQAB", 
			"kid": "75d0ef47-af89-47a9-9061-7c02a610d5ab", 
			"n": "o-yy1wpYmffgXBxhAUJzHHocCuJolwDqql75ZWuCQ_cb33K2vh9mk6GPM9gNN4Y_qTVX67WhsN3JvaFYw-fhvsWQ" 
		}, 
		{ 
			"kty": "RSA", 
			"e": "AQAB", 
			"kid": "d8fDFo-fS9-faS14a9-ASf99sa-7c1Ad5abA", 
			"n": "fc3f-yy1wpYmffgXBxhAUJzHql79gNNQ_cb33HocCuJolwDqmk6GPM4Y_qTVX67WhsN3JvaFYw-dfg6DH-asAScw"
		} 
	] 
}
```
## Self signed JWT via kid parameter

Sometimes, the header can contains a "kid" key that links to a file where the server secret key is stored  

***Example :***
```
{
  "alg": "HS256",
  "kid": "../key/secretkey.txt",
  "typ": "JWT"
}
```

If the jwt is signed with the content of the file, we can edit this file to make it point to /dev/null for example (which signes with a null string : %00)  

***Example :***  
```
{
  "alg": "HS256", 
  "kid": "../../../dev/null",
  "typ": "JWT"
}
```

## Other parameters

# Sources
- https://portswigger.net/web-security/jwt